#!/usr/bin/env dash
# Author: Daniel Rode
# Name: Wireless Connect
# Tags: connection, wrapper, macro, bluetooth, wifi
# Description: Connects to a given WiFi network by its SSID or to a Bluetooth
# 			   device via its mac address.
# Dependencies: nmcli, bluetoothctl
# Version: 2
# Init: 03 Nov 2021
# Updated: 15 Nov 2021


# Variables
help_text="Usage: ${0##*/} w|b SSID|MAC_ADDR"


# Functions
raise_input_error() {
	echo "error: $1"
	echo "$help_text"
	exit 1
}

wifi_connect() {
	ssid="$1"
	echo "Connecting..."
	while true
	do
		nmcli device wifi connect "$ssid" && break

		nmcli device wifi rescan
		sleep 3
	done
}

bluetooth_connect() {
	mac_addr="$1"
	bluetoothctl power on
	echo "Connecting..."
	while true
	do
		bluetoothctl connect "$mac_addr" && break
	done
}


# Main
if [ "$1" = "w" ]  # WiFi
then
	if [ -z "$2" ]
	then
		raise_input_error "Must provide WiFi network SSID"
	fi
	wifi_connect "$2"
elif [ "$1" = "b" ]  # Bluetooth
then
	if [ -z "$2" ]
	then
		raise_input_error "Must provide Bluetooth device mac address"
	fi
	bluetooth_connect "$2"
else
	raise_input_error "Invalid device type"
fi


# TODO
# - prompt for wifi password if one is required and not saved
# - display list of wifi visible networks if "wconnect w" is run without providing a SSID and do the same for "wconnect b" if MAC_ADDR is not provided
