#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# author: daniel rode
# name: dtach menu
# tags: processes, menu
# dependencies:
#   python 3.10+
#   dtach
#   fzf
#   pgrep
# created: 12 apr 2025
# updated: 19 dec 2025


# List active dtach sessions in a menu and then connect to the
# selected one.


import shlex
import subprocess as sp
from pathlib import Path


# Functions
def pgrep(query: str) -> list[list[str]]:
    cmd = ('pgrep', '--list-full', str(query))
    p = sp.run(cmd, check=True, text=True, capture_output=True)

    return p.stdout.strip().splitlines()


# Main

# Find active dtach sessions
dtach_socks = dict()
for proc in pgrep('dtach'):
    args = shlex.split(proc)
    sock_flags = ('-a', '-A', '-c', '-n', '-N', '-p')
    if (args[2] in sock_flags) and Path(args[3]).exists():
        dtach_socks[args[3]] = proc

# Display menu of active dtach sessions
cmd = (
    'fzf',
    '--delimiter= ',
    '--preview=pstree -aps {1}',
    '--preview-window=up,80%',
)
p = sp.run(
    cmd,
    text=True,
    input='\n'.join(list(dtach_socks.values())),
    stdout=sp.PIPE,
)
sock_path = shlex.split(p.stdout)[3]

# Connect to selected dtach session
sp.run(['dtach', '-a', sock_path])
